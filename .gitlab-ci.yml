image: wcr.io/mira/docker-maven:3.5.0-jdk9.0.1

stages:
  - maven_build
  - maven_deploy
  - trigger
  - release
    
maven_build:
  stage: maven_build
  script:
    - export
    - echo $MAVEN_SETTINGS_XML > settings.xml
    - mvn -B -s settings.xml clean install
  artifacts:
    when: always
    paths:
    - "*/target/test-output"
    - "*/target/surefire-reports"
    - "*/target/failsafe-reports"
  tags:
    - docker
    - privileged
  except:
    - /^release-.*$/

maven_deploy:
  stage: maven_deploy
  script:
    - export
    - echo $MAVEN_SETTINGS_XML > settings.xml
    - > 
      mvn -B -DaltDeploymentRepository=snapshots::default::$MAVEN_SNAPSHOTS_URL 
      -DskipTests=true -s settings.xml clean install deploy
  artifacts:
    when: always
    paths:
    - "*/target/test-output"
    - "*/target/surefire-reports"
    - "*/target/failsafe-reports"
  tags:
    - docker
    - privileged
  except:
    - /^release-.*$/

trigger-coherence-grpc:
  stage: trigger
  script:
    - >
      curl --insecure --request POST --form "token=$CI_JOB_TOKEN" --form ref=master 
      https://gitlab-odx.oracle.com/api/v4/projects/572/trigger/pipeline

trigger-release:
  except:
    - /^release-.*$/
  script:
    - 'which ssh-agent || (yum -y install git openssh-clients)'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - export
    - git checkout -b release-$CI_BUILD_ID
    - git config --global http.sslVerify false
    - git remote set-url --push origin git@gitlab-odx.oracle.com/mira/io-grpc.git
    - git push --set-upstream origin release-$CI_BUILD_ID
  stage: trigger
  tags:
    - docker
    - privileged
  when: manual

maven-release:
  stage: release
  script:
    - export
    - echo $MAVEN_SETTINGS_XML > settings.xml
  tags:
    - docker
    - privileged
  only:
    - /^release-.*$/
